package com.jzo2o.mall.order.service.impl;import cn.hutool.json.JSONConfig;import cn.hutool.json.JSONUtil;import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;import com.jzo2o.common.utils.DateUtils;import com.jzo2o.common.utils.JsonUtils;import com.jzo2o.common.utils.UserContext;import com.jzo2o.mall.cart.model.dto.CartDTO;import com.jzo2o.mall.cart.model.dto.CartSkuDTO;import com.jzo2o.mall.cart.model.dto.MemberCouponDTO;import com.jzo2o.mall.cart.model.dto.TradeDTO;import com.jzo2o.mall.cart.model.enums.CartTypeEnum;import com.jzo2o.mall.cart.model.enums.DeliveryMethodEnum;import com.jzo2o.mall.cart.service.CartService;import com.jzo2o.mall.cart.service.render.TradeBuilder;import com.jzo2o.mall.common.enums.OrderStatusEnum;import com.jzo2o.mall.common.enums.ResultCode;import com.jzo2o.mall.common.exception.ServiceException;import com.jzo2o.mall.common.model.AuthUser;import com.jzo2o.mall.member.model.domain.MemberAddress;import com.jzo2o.mall.member.service.MemberService;import com.jzo2o.mall.order.mapper.TradeMapper;import com.jzo2o.mall.order.model.domain.Order;import com.jzo2o.mall.order.model.domain.Trade;import com.jzo2o.mall.order.model.dto.OrderDTO;import com.jzo2o.mall.order.model.dto.OrderDetailDTO;import com.jzo2o.mall.order.model.dto.TradeParamsDTO;import com.jzo2o.mall.order.service.OrderService;import com.jzo2o.mall.order.service.TradeService;import com.jzo2o.mall.product.service.GoodsSkuService;import com.jzo2o.mall.promotion.model.dto.SeckillGoodsDTO;import com.jzo2o.mall.promotion.model.dto.SeckillTimelineDTO;import com.jzo2o.mall.promotion.model.enums.PromotionTypeEnum;import com.jzo2o.mall.promotion.service.CouponService;import com.jzo2o.mall.promotion.service.MemberCouponService;import com.jzo2o.mall.promotion.service.PromotionGoodsService;import com.jzo2o.mall.promotion.service.SeckillApplyService;import com.jzo2o.rabbitmq.client.RabbitClient;import com.jzo2o.redis.config.RedisConfiguration;import com.jzo2o.redis.helper.Cache;import com.jzo2o.redis.utils.RedisSyncQueueUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.ApplicationEventPublisher;import org.springframework.data.redis.core.RedisTemplate;import org.springframework.data.redis.core.script.DefaultRedisScript;import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;import org.springframework.data.redis.serializer.RedisSerializer;import org.springframework.data.redis.serializer.StringRedisSerializer;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import javax.annotation.Resource;import java.time.LocalDateTime;import java.util.ArrayList;import java.util.Collection;import java.util.List;import java.util.stream.Collectors;/** * 交易业务层实现 */@Servicepublic class TradeServiceImpl extends ServiceImpl<TradeMapper, Trade> implements TradeService {    /**     * 缓存     */    @Autowired    private Cache<Object> cache;    /**     * 订单     */    @Autowired    private OrderService orderService;    /**     * 会员     */    @Autowired    private MemberService memberService;    @Autowired    private CartService cartService;    @Autowired    private TradeBuilder tradeBuilder;    @Autowired    private SeckillApplyService seckillApplyService;    /**     * 优惠券     */    @Autowired    private CouponService couponService;    /**     * 会员优惠券     */    @Autowired    private MemberCouponService memberCouponService;    @Resource    private RabbitClient rabbitClient;    @Autowired    private ApplicationEventPublisher applicationEventPublisher;    @Autowired    private DefaultRedisScript<Boolean> seckillScript;    @Autowired    private RedisTemplate redisTemplate;    @Override    @Transactional(rollbackFor = Exception.class)    public TradeDTO createTrade(TradeParamsDTO tradeParams) {        //购买方式        CartTypeEnum cartTypeEnum = CartTypeEnum.valueOf(tradeParams.getWay());        //从购物车取出交易信息        TradeDTO tradeDTO = cartService.readDTO(cartTypeEnum);        //设置基础属性        //客户端类型        tradeDTO.setClientType(tradeParams.getClient());        //店铺备注        tradeDTO.setStoreRemark(tradeParams.getRemark());        //订单无收货地址校验        if (tradeDTO.getMemberAddress() == null ) {            throw new ServiceException(ResultCode.MEMBER_ADDRESS_NOT_EXIST);        }        //构建交易        tradeDTO = tradeBuilder.renderTradeByCart(tradeDTO);        //创建订单预校验        createTradeCheck(tradeDTO);        Trade trade = new Trade(tradeDTO);        //优惠券预处理        couponPretreatment(tradeDTO);        //添加交易        this.save(trade);        //添加订单        List<OrderDTO> orderDTOS = orderService.intoDB(tradeDTO);        //清除购物车,缓存中并不存储cartList数据，所以这里重新从redis查询购物车数据，清除已经下单的商品        cartService.cleanChecked(cartService.readDTO(cartTypeEnum));//        cartService.cleanChecked(cartService.readDTO(cartTypeEnum));        //取出tradeDTO中的订单信息//        List<OrderDTO> orderDTO = tradeDTO.getOrderDTO();        //遍历订单信息，发送订单创建消息        for (OrderDTO order : orderDTOS) {            OrderDetailDTO orderDetailDTO = orderService.queryDetail(order.getSn());            orderService.sendUpdateStatusMessage(orderDetailDTO, null, OrderStatusEnum.UNPAID);        }        return tradeDTO;    }    /**     * 提交秒杀订单     * @param tradeParams     * @return     */    public TradeDTO createSeckillTrade(TradeParamsDTO tradeParams){        //取出当前登录用户        AuthUser currentUser = UserContext.getCurrentUser();        //秒杀采用立即购买方式        CartTypeEnum cartTypeEnum = CartTypeEnum.SECKILL;        TradeDTO tradeDTO = cartService.readDTO(cartTypeEnum);        //设置基础属性        //客户端类型        tradeDTO.setClientType(tradeParams.getClient());        //店铺备注        tradeDTO.setStoreRemark(tradeParams.getRemark());        //订单无收货地址校验//        if (tradeDTO.getStoreAddress() == null && tradeDTO.getMemberAddress() == null && !GoodsTypeEnum.VIRTUAL_GOODS.name().equals(tradeDTO.getCheckedSkuList().get(0).getGoodsSku().getGoodsType())) {        if ( tradeDTO.getMemberAddress() == null ) {            throw new ServiceException(ResultCode.MEMBER_ADDRESS_NOT_EXIST);        }        //构建交易        tradeDTO = tradeBuilder.renderSeckillTrade(tradeDTO);        // 购物车选择状态判断        if (tradeDTO.getCartList().stream().noneMatch(CartDTO::getChecked)) {            throw new ServiceException(ResultCode.ORDER_NOT_EXIST_VALID);        }        //从tradeDTO中取出第一个选中的sku        CartSkuDTO cartSkuDTO = tradeDTO.getCheckedSkuList().stream().findFirst().get();        String skuId = cartSkuDTO.getGoodsSku().getId();        //校验秒杀商品秒杀状态        //根据当前日期获取秒杀活动信息        String now = DateUtils.format(LocalDateTime.now(), "yyyy-MM-dd");        //从缓存中获取当天的秒杀活动列表        List<SeckillTimelineDTO> seckillTimeline = seckillApplyService.getSeckillTimeline(now);        //根据skuid从seckillTimeline取出秒杀活动信息        SeckillTimelineDTO seckillTimelineDTO = seckillTimeline.stream().filter(i -> i.getSeckillGoodsList().stream().anyMatch(j -> j.getSkuId().equals(skuId))).findFirst().orElse(null);        if(seckillTimelineDTO == null){            throw new ServiceException(ResultCode.GOODS_NOT_EXIST);        }        //从seckillTimelineDTO中取出秒杀商品        SeckillGoodsDTO seckillGoodsDTO = seckillTimelineDTO.getSeckillGoodsList().stream().filter(i -> i.getSkuId().equals(skuId)).findFirst().orElse(null);        if(seckillGoodsDTO == null || seckillGoodsDTO.getPromotionGoods() == null){            throw new ServiceException(ResultCode.GOODS_NOT_EXIST);        }        //活动id        String promotionId = seckillGoodsDTO.getPromotionGoods().getPromotionId();//        //创建订单预校验//        createTradeCheck(tradeDTO);        //调用lua脚本扣减库存        List<String> keys = new ArrayList<>();        List<Object> args = new ArrayList<>();        //购买数量        int num = -cartSkuDTO.getNum();        String stockCacheKey = GoodsSkuService.getStockCacheKey(skuId);        //sku库存key        keys.add(stockCacheKey);        //秒杀库存key        String promotionGoodsStockCacheKey = PromotionGoodsService.getPromotionGoodsStockCacheKey(PromotionTypeEnum.SECKILL, promotionId, cartSkuDTO.getGoodsSku().getId());        keys.add(promotionGoodsStockCacheKey);        //秒杀成功队列key        int index = (int) (Long.parseLong(promotionId) % 10);        String seckillSuccessKey = String.format("SECKILL:%s:{%s}", promotionId, index);        keys.add(seckillSuccessKey);        //秒杀成功同步队列key        String seckillSyncRedisKey = RedisSyncQueueUtils.getQueueRedisKey("SECKILL:SYNC", index);        keys.add(seckillSyncRedisKey);        //ages[扣减库存数量,用户id,下单时间戳秒值,TradeDTO信息]        args.add(num);        args.add(currentUser.getId());        args.add(System.currentTimeMillis()/1000);        args.add(tradeDTO);        //库存扣除结果        RedisSerializer<String> stringSerializer = new StringRedisSerializer();        GenericJackson2JsonRedisSerializer jsonRedisSerializer = RedisConfiguration.createJsonRedisSerializer();        Boolean skuResult   = (Boolean) redisTemplate.execute(seckillScript,                jsonRedisSerializer,stringSerializer,                keys, args.toArray());        if(!skuResult){            throw new ServiceException(ResultCode.SECKILL_ERROR);        }////        Trade trade = new Trade(tradeDTO);////        String key = CachePrefix.TRADE.getPrefix() + trade.getSn();//        //优惠券预处理////        couponPretreatment(tradeDTO);////        //积分预处理////        pointPretreatment(tradeDTO);//        //添加交易//        this.save(trade);//        //添加订单//        orderService.intoDB(tradeDTO);////        //砍价订单处理////        kanjiaPretreatment(tradeDTO);//        //写入缓存，给消费者调用////        cache.put(key, JSONUtil.toJsonStr(tradeDTO));//////        applicationEventPublisher.publishEvent(new TransactionCommitSendMQEvent("订单创建消息", rocketmqCustomProperties.getOrderTopic(),////                OrderTagsEnum.ORDER_CREATE.name(), key));////        //发送消息通知其他系统////        //构造消息内容////        OrderMessage orderMessage = new OrderMessage();////        orderMessage.setTradeSn(trade.getSn());////        //发送消息////        rabbitClient.sendMsg(MallMqConstants.Exchanges.EXCHANGE_ORDER, MallMqConstants.RoutingKeys.ORDER_CREATE_KEY, orderMessage);        //清除购物车        cartService.cleanChecked(cartService.readDTO(cartTypeEnum));        return tradeDTO;    }    /**     * 创建订单最后一步校验     *     * @param tradeDTO 购物车视图     */    private void createTradeCheck(TradeDTO tradeDTO) {        // 购物车选择状态判断        if (tradeDTO.getCartList().stream().noneMatch(CartDTO::getChecked)) {            throw new ServiceException(ResultCode.ORDER_NOT_EXIST_VALID);        }        if (tradeDTO.getCartTypeEnum().equals(CartTypeEnum.CART) ) {//            if (memberAddress == null && !GoodsTypeEnum.VIRTUAL_GOODS.name().equals(tradeDTO.getCheckedSkuList().get(0).getGoodsSku().getGoodsType())) {            if ( tradeDTO.getMemberAddress() == null ) {                throw new ServiceException(ResultCode.MEMBER_ADDRESS_NOT_EXIST);            }            //订单配送区域校验            if (tradeDTO.getNotSupportFreight() != null && !tradeDTO.getNotSupportFreight().isEmpty()) {                StringBuilder stringBuilder = new StringBuilder("包含商品有-");                tradeDTO.getNotSupportFreight().forEach(sku -> stringBuilder.append(sku.getGoodsSku().getGoodsName()));                throw new ServiceException(ResultCode.ORDER_NOT_SUPPORT_DISTRIBUTION, stringBuilder.toString());            }            if (tradeDTO.getCartList().stream().allMatch(item -> DeliveryMethodEnum.SELF_PICK_UP.name().equals(item.getDeliveryMethod()))) {                throw new ServiceException(ResultCode.STORE_ADDRESS_NOT_EXIST);            }        }    }    @Override    public Trade getBySn(String sn) {        LambdaQueryWrapper<Trade> queryWrapper = new LambdaQueryWrapper<>();        queryWrapper.eq(Trade::getSn, sn);        return this.getOne(queryWrapper);    }//    @Override//    @Transactional(rollbackFor = Exception.class)//    public void payTrade(String tradeSn, String paymentName, String receivableNo) {//        LambdaQueryWrapper<Order> orderQueryWrapper = new LambdaQueryWrapper<>();//        orderQueryWrapper.eq(Order::getTradeSn, tradeSn);//        List<Order> orders = orderService.list(orderQueryWrapper);//        for (Order order : orders) {//            orderService.payOrder(order.getSn(), paymentName, receivableNo);//        }//        Trade trade = this.getBySn(tradeSn);//        trade.setPayStatus(PayStatusEnum.PAID.name());//        this.saveOrUpdate(trade);//    }    @Override    public void updateTradePrice(String tradeSn) {        this.baseMapper.updateTradePrice(tradeSn);    }    /**     * 优惠券预处理     * 下单同时，扣除优惠券     *     * @param tradeDTO 购物车视图     */    private void couponPretreatment(TradeDTO tradeDTO) {        List<MemberCouponDTO> memberCouponDTOList = new ArrayList<>();        if (null != tradeDTO.getPlatformCoupon()) {            memberCouponDTOList.add(tradeDTO.getPlatformCoupon());            //使用平台优惠券            memberCouponService.used(tradeDTO.getMemberId(), tradeDTO.getPlatformCoupon().getMemberCoupon().getId());        }        Collection<MemberCouponDTO> storeCoupons = tradeDTO.getStoreCoupons().values();        if (!storeCoupons.isEmpty()) {            memberCouponDTOList.addAll(storeCoupons);            for (MemberCouponDTO storeCoupon : storeCoupons) {                //使用店铺优惠券                memberCouponService.used(tradeDTO.getMemberId(), storeCoupon.getMemberCoupon().getId());            }        }//        List<String> ids = memberCouponDTOList.stream().map(e -> e.getMemberCoupon().getId()).collect(Collectors.toList());//        memberCouponService.used(tradeDTO.getMemberId(), ids);        memberCouponDTOList.forEach(e -> couponService.usedCoupon(e.getMemberCoupon().getCouponId(), 1));    }////    /**//     * 创建交易，积分处理//     *//     * @param tradeDTO 购物车视图//     *///    private void pointPretreatment(TradeDTO tradeDTO) {////        //需要支付积分//        if (tradeDTO.getPriceDetailDTO() != null//                && tradeDTO.getPriceDetailDTO().getPayPoint() != null//                && tradeDTO.getPriceDetailDTO().getPayPoint() > 0) {//            StringBuilder orderSns = new StringBuilder();//            for (CartVO item : tradeDTO.getCartList()) {//                orderSns.append(item.getSn());//            }//            boolean result = memberService.updateMemberPoint(tradeDTO.getPriceDetailDTO().getPayPoint(), PointTypeEnum.REDUCE.name(),//                    tradeDTO.getMemberId(),//                    "订单【" + orderSns + "】创建，积分扣减");////            if (!result) {//                throw new ServiceException(ResultCode.PAY_POINT_ENOUGH);//            }//        }//    }////    /**//     * 创建交易、砍价处理//     *//     * @param tradeDTO 购物车视图//     *///    private void kanjiaPretreatment(TradeDTO tradeDTO) {//        if (tradeDTO.getCartTypeEnum().equals(CartTypeEnum.KANJIA)) {//            String kanjiaId = tradeDTO.getSkuList().get(0).getKanjiaId();//            kanjiaActivityService.endKanjiaActivity(kanjiaId);//        }//    }}